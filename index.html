<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión Librería Completa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; display: flex; background: #f4f4f4; }
        .sidebar { width: 280px; background: #333; color: #fff; padding: 20px; display: flex; flex-direction: column; min-height: 100vh; }
        .sidebar h2 { text-align: center; font-size: 24px; margin-bottom: 20px; }
        .sidebar a { color: #fff; text-decoration: none; padding: 10px; margin: 5px 0; background: #444; border-radius: 5px; text-align: center; transition: background 0.3s;}
        .sidebar a:hover, .sidebar a.active { background: #4CAF50; }
        .content { flex: 1; padding: 20px; overflow-y: auto; }
        section { display: none; }
        section.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
        th { background: #4CAF50; color: #fff; }
        form { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
        input, select, button { padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 48%; }
        button { background: #4CAF50; color: #fff; cursor: pointer; }
        button:hover { background: #388d3c; }
        .alerta-stock { color: #fff; background: #c0392b; padding: 2px 8px; border-radius: 6px; font-size: 13px; margin-left: 5px;}
        .b-action { background: #e67e22; color: #fff; border: none; padding: 6px 10px; border-radius:4px; cursor:pointer;}
        .b-action:hover { background: #ca6f1e;}
        .danger { background: #c0392b; color: #fff; border: none; }
        .danger:hover { background: #a93226; }
        .seccion {margin-bottom: 30px;}
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Gestión Librería</h2>
        <a href="#" data-section="productos" class="active">Productos</a>
        <a href="#" data-section="compras">Compras</a>
        <a href="#" data-section="ventas">Ventas</a>
        <a href="#" data-section="clientes">Clientes</a>
        <a href="#" data-section="proveedores">Proveedores</a>
        <a href="#" data-section="gastos">Gastos</a>
        <a href="#" data-section="reportes">Reportes</a>
        <a href="#" data-section="libros">Libros Contables</a>
        <a href="#" data-section="formatear">Formatear Todo</a>
    </div>
    <div class="content">
        <!-- Maestro de Productos -->
        <section id="productos" class="active">
            <h1>Maestro de Productos</h1>
            <form id="formAgregarProducto">
                <input type="text" id="nombreProducto" placeholder="Nombre del Producto" required>
                <input type="number" id="precioVenta" placeholder="Precio Venta s/IVA" min="0" required>
                <select id="ivaProducto" required>
                    <option value="0">IVA 0%</option>
                    <option value="0.105">IVA 10,5%</option>
                    <option value="0.21">IVA 21%</option>
                </select>
                <input type="number" id="stockMin" placeholder="Stock mínimo" min="0" value="0">
                <button type="submit">Agregar Producto</button>
            </form>
            <table>
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Precio Compra s/IVA</th>
                        <th>Precio Venta s/IVA</th>
                        <th>IVA (%)</th>
                        <th>Margen (%)</th>
                        <th>Stock</th>
                        <th>Stock Mín.</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaProductos"></tbody>
            </table>
        </section>

        <!-- Compras -->
        <section id="compras">
            <h1>Registrar Compra</h1>
            <form id="formRegistrarCompra">
                <select id="productoCompra" required>
                    <option value="">Seleccione un Producto</option>
                </select>
                <input type="number" id="cantidadCompra" placeholder="Cantidad" min="1" required>
                <input type="number" id="precioCompraUnitario" placeholder="Precio Unitario s/IVA" min="0" required>
                <select id="proveedorCompra" required>
                    <option value="">Seleccione un Proveedor</option>
                </select>
                <select id="ivaCompra" required>
                    <option value="0">IVA 0%</option>
                    <option value="0.105">IVA 10,5%</option>
                    <option value="0.21">IVA 21%</option>
                </select>
                <button type="submit">Registrar Compra</button>
            </form>
            <table>
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio s/IVA</th>
                        <th>IVA (%)</th>
                        <th>Total</th>
                        <th>Proveedor</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaCompras"></tbody>
            </table>
        </section>

        <!-- Ventas -->
        <section id="ventas">
            <h1>Registrar Venta</h1>
            <form id="formRegistrarVenta">
                <select id="productoVenta" required>
                    <option value="">Seleccione un Producto</option>
                </select>
                <input type="number" id="cantidadVenta" placeholder="Cantidad" min="1" required>
                <input type="number" id="descuentoVenta" placeholder="Descuento (%)" min="0" max="100" value="0">
                <select id="tipoPagoVenta" required>
                    <option value="Efectivo">Efectivo</option>
                    <option value="Transferencia">Transferencia</option>
                    <option value="Débito">Débito</option>
                    <option value="Crédito">Crédito</option>
                </select>
                <select id="clienteVenta" required>
                    <option value="">Seleccione un Cliente</option>
                </select>
                <select id="ivaVenta" required>
                    <option value="0">IVA 0%</option>
                    <option value="0.105">IVA 10,5%</option>
                    <option value="0.21">IVA 21%</option>
                </select>
                <button type="submit">Registrar Venta</button>
            </form>
            <table>
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario s/IVA</th>
                        <th>Descuento (%)</th>
                        <th>IVA (%)</th>
                        <th>Total</th>
                        <th>Tipo de pago</th>
                        <th>Cliente</th>
                        <th>Fecha</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaVentas"></tbody>
            </table>
        </section>

        <!-- Clientes -->
        <section id="clientes">
            <h1>Gestión de Clientes</h1>
            <form id="formAgregarCliente">
                <input type="text" id="nombreCliente" placeholder="Nombre del Cliente" required>
                <button type="submit">Agregar Cliente</button>
            </form>
            <table>
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaClientes"></tbody>
            </table>
        </section>

        <!-- Proveedores -->
        <section id="proveedores">
            <h1>Gestión de Proveedores</h1>
            <form id="formAgregarProveedor">
                <input type="text" id="nombreProveedor" placeholder="Nombre del Proveedor" required>
                <button type="submit">Agregar Proveedor</button>
            </form>
            <table>
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaProveedores"></tbody>
            </table>
        </section>

        <!-- Gastos -->
        <section id="gastos">
            <h1>Registro de Gastos</h1>
            <form id="formRegistrarGasto">
                <select id="categoriaGasto" required>
                    <option value="">Categoría</option>
                    <option value="Energía">Energía</option>
                    <option value="Gas">Gas</option>
                    <option value="Teléfono">Teléfono</option>
                    <option value="Internet">Internet</option>
                    <option value="Otro">Otro</option>
                </select>
                <select id="proveedorGasto" required>
                    <option value="">Seleccione un Proveedor</option>
                </select>
                <input type="number" id="montoGasto" placeholder="Monto s/IVA" min="0" required>
                <select id="ivaGasto" required>
                    <option value="0">IVA 0%</option>
                    <option value="0.105">IVA 10,5%</option>
                    <option value="0.21">IVA 21%</option>
                </select>
                <input type="text" id="detalleGasto" placeholder="Detalle (opcional)">
                <button type="submit">Registrar Gasto</button>
            </form>
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Categoría</th>
                        <th>Proveedor</th>
                        <th>Monto s/IVA</th>
                        <th>IVA (%)</th>
                        <th>Total</th>
                        <th>Detalle</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaGastos"></tbody>
            </table>
        </section>

        <!-- Reportes -->
        <section id="reportes">
            <h1>Reportes</h1>
            <div>
                <label>Tipo:</label>
                <select id="tipoReporte">
                    <option value="diario">Diario</option>
                    <option value="mensual">Mensual</option>
                </select>
                <label>Fecha:</label>
                <input type="date" id="fechaReporte">
                <button onclick="mostrarReporte()" type="button">Mostrar</button>
            </div>
            <div id="reporteResultado"></div>
        </section>

        <!-- Libros Contables -->
        <section id="libros">
            <h1>Libros Contables</h1>
            <h3>Libro Diario</h3>
            <table>
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Descripción</th>
                        <th>Cuenta</th>
                        <th>Debe</th>
                        <th>Haber</th>
                    </tr>
                </thead>
                <tbody id="tablaLibroDiario"></tbody>
            </table>
            <h3>Libro Mayor</h3>
            <table>
                <thead>
                    <tr>
                        <th>Cuenta</th>
                        <th>Saldo</th>
                    </tr>
                </thead>
                <tbody id="tablaLibroMayor"></tbody>
            </table>
        </section>

        <!-- Formatear -->
        <section id="formatear">
            <h1>Formatear Todo</h1>
            <button class="danger" onclick="formatearTodo()">Formatear y Borrar Todos los Datos</button>
            <p><b>¡ATENCIÓN!</b> Esta acción borrará toda la información y no podrá recuperarse.</p>
        </section>
    </div>
    <script>
        // Utilidades y persistencia
        function getLS(key, def=[]) { return JSON.parse(localStorage.getItem(key)) || def; }
        function setLS(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
        function round2(n) { return Math.round(n*100)/100; }
        function formatearTodo() {
            if(confirm("¿Seguro que desea borrar todos los datos? Esto no se puede deshacer.")) {
                localStorage.clear();
                location.reload();
            }
        }

        // PLAN DE CUENTAS
        // Activo
        // - Caja
        // - Bancos
        // - Cuentas por cobrar
        // - Inventarios
        // - Mobiliario y equipo
        // - IVA Crédito Fiscal
        // Pasivo
        // - Proveedores
        // - Cuentas por pagar
        // - Préstamos
        // - IVA Débito Fiscal
        // Patrimonio Neto
        // - Capital Social
        // - Resultados acumulados
        // Resultado positivo o negativo
        // - Ingresos por ventas
        // - Gastos operativos
        // - Costos de ventas
        // - Impuestos

        const cuentas = [
            'Caja', 'Bancos', 'Cuentas por cobrar', 'Inventarios', 'Mobiliario y equipo',
            'IVA Crédito Fiscal', 'Proveedores', 'Cuentas por pagar', 'Préstamos',
            'IVA Débito Fiscal', 'Capital Social', 'Resultados acumulados',
            'Ingresos por ventas', 'Gastos operativos', 'Costos de ventas', 'Impuestos',
            'Descuentos por ventas'
        ];

        // Datos
        let productos = getLS('productos');
        let compras = getLS('compras');
        let ventas = getLS('ventas');
        let clientes = getLS('clientes');
        let proveedores = getLS('proveedores');
        let gastos = getLS('gastos');
        let libroDiario = getLS('libroDiario');
        let libroMayor = getLS('libroMayor', {});

        // Navegación
        document.querySelectorAll('.sidebar a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
                link.classList.add('active');
                document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
                document.getElementById(link.dataset.section).classList.add('active');
                recargarTablas();
            });
        });

        function recargarTablas() {
            mostrarProductos();
            mostrarCompras();
            mostrarVentas();
            mostrarClientes();
            mostrarProveedores();
            mostrarGastos();
            cargarSelects();
            mostrarLibroDiario();
            mostrarLibroMayor();
        }

        // Maestro de productos
        document.getElementById('formAgregarProducto').onsubmit = function(e) {
            e.preventDefault();
            const nombre = document.getElementById('nombreProducto').value.trim();
            const precioVenta = parseFloat(document.getElementById('precioVenta').value);
            const iva = parseFloat(document.getElementById('ivaProducto').value);
            const stockMin = parseInt(document.getElementById('stockMin').value) || 0;
            if (!nombre || isNaN(precioVenta) || isNaN(iva)) return;
            let idx = productos.findIndex(p => p.nombre===nombre);
            if(idx >=0){
                alert('El producto ya existe.');
                return;
            }
            productos.push({nombre, precioVenta, iva, stockMin, stock:0, precioCompra:0});
            setLS('productos', productos);
            this.reset();
            mostrarProductos();
            cargarSelects();
        };
        function mostrarProductos() {
            const tb = document.getElementById('tablaProductos');
            tb.innerHTML = '';
            productos.forEach((prod, i) => {
                const margen = prod.precioCompra > 0 ? round2((prod.precioVenta-prod.precioCompra)*100/prod.precioCompra) : 0;
                tb.innerHTML += `<tr>
                    <td>${prod.nombre}</td>
                    <td>${prod.precioCompra ? prod.precioCompra.toFixed(2) : '-'}</td>
                    <td>${prod.precioVenta.toFixed(2)}</td>
                    <td>${(prod.iva*100).toFixed(1)}%</td>
                    <td>${prod.precioCompra > 0 ? margen + '%' : '-'}</td>
                    <td>${prod.stock}${prod.stock<=prod.stockMin?'<span class="alerta-stock">¡Bajo!</span>':''}</td>
                    <td>${prod.stockMin||0}</td>
                    <td><button onclick="eliminarProducto(${i})">Eliminar</button></td>
                </tr>`;
            });
        }
        window.eliminarProducto = function(i){
            productos.splice(i,1);
            setLS('productos', productos);
            mostrarProductos();
            cargarSelects();
        };

        // Compras
        document.getElementById('formRegistrarCompra').onsubmit = function(e){
            e.preventDefault();
            const producto = document.getElementById('productoCompra').value;
            const cantidad = parseInt(document.getElementById('cantidadCompra').value);
            const precioCompraUnitario = parseFloat(document.getElementById('precioCompraUnitario').value);
            const iva = parseFloat(document.getElementById('ivaCompra').value);
            const proveedor = document.getElementById('proveedorCompra').value;
            const fecha = new Date().toLocaleString();
            let prod = productos.find(p=>p.nombre===producto);
            if(!prod) { alert("Primero debe dar de alta el producto en el maestro."); return; }
            if(isNaN(cantidad) || cantidad<=0 || isNaN(precioCompraUnitario) || !proveedor) return;
            prod.stock = (prod.stock||0) + cantidad;
            prod.precioCompra = precioCompraUnitario;
            prod.iva = iva;
            setLS('productos', productos);
            const subtotal = precioCompraUnitario*cantidad;
            const ivaMonto = subtotal*iva;
            const total = subtotal + ivaMonto;
            compras.push({fecha, producto, cantidad, precioCompraUnitario, iva, total, proveedor});
            setLS('compras', compras);

            // Libro Diario y Mayor
            registrarLibroDiario({
                fecha,
                descripcion: `Compra de ${cantidad} ${producto} a ${proveedor}`,
                asientos: [
                    {cuenta: 'Inventarios', debe: subtotal, haber: 0},
                    {cuenta: 'IVA Crédito Fiscal', debe: ivaMonto, haber: 0},
                    {cuenta: 'Caja', debe: 0, haber: total}
                ]
            });
            actualizarLibroMayor('Inventarios', subtotal);
            actualizarLibroMayor('IVA Crédito Fiscal', ivaMonto);
            actualizarLibroMayor('Caja', -total);

            mostrarProductos();
            mostrarCompras();
            mostrarLibroDiario();
            mostrarLibroMayor();
            cargarSelects();
            this.reset();
        };
        function mostrarCompras(){
            const tb = document.getElementById('tablaCompras');
            tb.innerHTML = '';
            compras.slice().reverse().forEach((c, idx)=>{
                tb.innerHTML += `<tr>
                    <td>${c.producto}</td>
                    <td>${c.cantidad}</td>
                    <td>${c.precioCompraUnitario.toFixed(2)}</td>
                    <td>${(c.iva*100).toFixed(1)}%</td>
                    <td>${c.total.toFixed(2)}</td>
                    <td>${c.proveedor}</td>
                    <td>${c.fecha}</td>
                    <td>
                        <button class="b-action" onclick="editarCompra(${compras.length-1-idx})">Editar</button>
                        <button class="b-action" onclick="eliminarCompra(${compras.length-1-idx})">Eliminar</button>
                    </td>
                </tr>`;
            });
        }
        window.editarCompra = function(idx){
            const c = compras[idx];
            if(!c) return;
            document.getElementById('productoCompra').value = c.producto;
            document.getElementById('cantidadCompra').value = c.cantidad;
            document.getElementById('precioCompraUnitario').value = c.precioCompraUnitario;
            document.getElementById('ivaCompra').value = c.iva;
            document.getElementById('proveedorCompra').value = c.proveedor;
            eliminarCompra(idx);
        };
        window.eliminarCompra = function(idx){
            const c = compras[idx];
            if(!c) return;
            let prod = productos.find(p=>p.nombre===c.producto);
            if(prod) prod.stock -= c.cantidad;
            compras.splice(idx,1);
            setLS('compras', compras);
            setLS('productos', productos);
            mostrarCompras();
            mostrarProductos();
        };

        // Ventas
        document.getElementById('formRegistrarVenta').onsubmit = function(e){
            e.preventDefault();
            const producto = document.getElementById('productoVenta').value;
            const cantidad = parseInt(document.getElementById('cantidadVenta').value);
            const descuentoPorc = parseFloat(document.getElementById('descuentoVenta').value) || 0;
            const tipoPago = document.getElementById('tipoPagoVenta').value;
            const iva = parseFloat(document.getElementById('ivaVenta').value);
            const cliente = document.getElementById('clienteVenta').value;
            const fecha = new Date().toLocaleString();
            let prod = productos.find(p=>p.nombre===producto);
            if(!prod) { alert("Elija un producto válido."); return; }
            if(isNaN(cantidad) || cantidad<=0 || !cliente) return;
            if(prod.stock < cantidad){
                alert('Stock insuficiente.');
                return;
            }
            const precioUnitario = prod.precioVenta;
            const subtotal = precioUnitario * cantidad;
            const descuento = subtotal * (descuentoPorc/100);
            const base = subtotal - descuento;
            const ivaMonto = base * iva;
            const total = base + ivaMonto;
            ventas.push({fecha, producto, cantidad, precioUnitario, descuento: descuentoPorc, iva, total, tipoPago, cliente});
            setLS('ventas', ventas);
            prod.stock -= cantidad;
            setLS('productos', productos);

            // Libro Diario y Mayor - Plan de cuentas adaptado
            // - Caja/Bancos según tipo de pago
            // - Ingresos por ventas (haber: base)
            // - Descuentos por ventas (debe)
            // - IVA Débito Fiscal (haber: ivaMonto)
            // - Costos de ventas (debe: precioCompra*cantidad), Inventarios (haber: precioCompra*cantidad)

            let cuentaPago = (tipoPago==="Efectivo"||tipoPago==="Débito") ? "Caja"
                            : (tipoPago==="Transferencia"||tipoPago==="Bancos") ? "Bancos"
                            : "Caja"; // por defecto Caja

            let costoVenta = (prod.precioCompra||0) * cantidad;
            let asientos = [
                {cuenta: cuentaPago, debe: total, haber: 0},
                {cuenta: 'Ingresos por ventas', debe: 0, haber: base},
                {cuenta: 'IVA Débito Fiscal', debe: 0, haber: ivaMonto}
            ];
            if(descuentoPorc>0) asientos.push({cuenta: 'Descuentos por ventas', debe: descuento, haber: 0});
            // Costos de ventas (coste de mercadería vendida), Inventarios
            if(costoVenta>0) {
                asientos.push({cuenta: 'Costos de ventas', debe: costoVenta, haber: 0});
                asientos.push({cuenta: 'Inventarios', debe: 0, haber: costoVenta});
            }
            registrarLibroDiario({
                fecha,
                descripcion: `Venta de ${cantidad} ${producto} a ${cliente} (${tipoPago})`,
                asientos
            });
            actualizarLibroMayor(cuentaPago, total);
            actualizarLibroMayor('Ingresos por ventas', -base);
            actualizarLibroMayor('IVA Débito Fiscal', -ivaMonto);
            if(descuentoPorc>0) actualizarLibroMayor('Descuentos por ventas', descuento);
            if(costoVenta>0) {
                actualizarLibroMayor('Costos de ventas', costoVenta);
                actualizarLibroMayor('Inventarios', -costoVenta);
            }

            mostrarProductos();
            mostrarVentas();
            mostrarLibroDiario();
            mostrarLibroMayor();
            cargarSelects();
            this.reset();
        };
        function mostrarVentas(){
            const tb = document.getElementById('tablaVentas');
            tb.innerHTML = '';
            ventas.slice().reverse().forEach((v, idx)=>{
                tb.innerHTML += `<tr>
                    <td>${v.producto}</td>
                    <td>${v.cantidad}</td>
                    <td>${v.precioUnitario.toFixed(2)}</td>
                    <td>${v.descuento || 0}%</td>
                    <td>${(v.iva*100).toFixed(1)}%</td>
                    <td>${v.total.toFixed(2)}</td>
                    <td>${v.tipoPago}</td>
                    <td>${v.cliente}</td>
                    <td>${v.fecha}</td>
                    <td>
                        <button class="b-action" onclick="editarVenta(${ventas.length-1-idx})">Editar</button>
                        <button class="b-action" onclick="eliminarVenta(${ventas.length-1-idx})">Eliminar</button>
                    </td>
                </tr>`;
            });
        }
        window.editarVenta = function(idx){
            const v = ventas[idx];
            if(!v) return;
            document.getElementById('productoVenta').value = v.producto;
            document.getElementById('cantidadVenta').value = v.cantidad;
            document.getElementById('descuentoVenta').value = v.descuento || 0;
            document.getElementById('tipoPagoVenta').value = v.tipoPago;
            document.getElementById('ivaVenta').value = v.iva;
            document.getElementById('clienteVenta').value = v.cliente;
            eliminarVenta(idx);
        };
        window.eliminarVenta = function(idx){
            const v = ventas[idx];
            if(!v) return;
            let prod = productos.find(p=>p.nombre===v.producto);
            if(prod) prod.stock += v.cantidad;
            ventas.splice(idx,1);
            setLS('ventas', ventas);
            setLS('productos', productos);
            mostrarVentas();
            mostrarProductos();
        };

        // Clientes
        document.getElementById('formAgregarCliente').onsubmit = function(e){
            e.preventDefault();
            const nombre = document.getElementById('nombreCliente').value.trim();
            if(nombre && !clientes.some(c => c.nombre===nombre)){
                clientes.push({nombre});
                setLS('clientes', clientes);
            }
            this.reset();
            mostrarClientes();
            cargarSelects();
        };
        function mostrarClientes(){
            const tb = document.getElementById('tablaClientes');
            tb.innerHTML = '';
            clientes.forEach((c,i)=>{
                tb.innerHTML += `<tr>
                    <td>${c.nombre}</td>
                    <td><button onclick="eliminarCliente(${i})">Eliminar</button></td>
                </tr>`;
            });
        }
        window.eliminarCliente = function(i){
            clientes.splice(i,1);
            setLS('clientes', clientes);
            mostrarClientes();
            cargarSelects();
        };

        // Proveedores
        document.getElementById('formAgregarProveedor').onsubmit = function(e){
            e.preventDefault();
            const nombre = document.getElementById('nombreProveedor').value.trim();
            if(nombre && !proveedores.some(p => p.nombre===nombre)){
                proveedores.push({nombre});
                setLS('proveedores', proveedores);
            }
            this.reset();
            mostrarProveedores();
            cargarSelects();
        };
        function mostrarProveedores(){
            const tb = document.getElementById('tablaProveedores');
            tb.innerHTML = '';
            proveedores.forEach((p,i)=>{
                tb.innerHTML += `<tr>
                    <td>${p.nombre}</td>
                    <td><button onclick="eliminarProveedor(${i})">Eliminar</button></td>
                </tr>`;
            });
        }
        window.eliminarProveedor = function(i){
            proveedores.splice(i,1);
            setLS('proveedores', proveedores);
            mostrarProveedores();
            cargarSelects();
        };

        // Gastos
        document.getElementById('formRegistrarGasto').onsubmit = function(e){
            e.preventDefault();
            const categoria = document.getElementById('categoriaGasto').value;
            const proveedor = document.getElementById('proveedorGasto').value.trim();
            const monto = parseFloat(document.getElementById('montoGasto').value);
            const iva = parseFloat(document.getElementById('ivaGasto').value);
            const detalle = document.getElementById('detalleGasto').value.trim();
            const fecha = new Date().toLocaleString();
            if(!categoria || !proveedor || isNaN(monto) || isNaN(iva)) return;
            const total = monto + monto*iva;
            gastos.push({fecha, categoria, proveedor, monto, iva, total, detalle});
            setLS('gastos', gastos);

            // Libro Diario
            registrarLibroDiario({
                fecha,
                descripcion: `Gasto: ${categoria} a ${proveedor}` + (detalle? ' ('+detalle+')':''),
                asientos: [
                    {cuenta: 'Gastos operativos', debe: monto, haber: 0},
                    {cuenta: 'IVA Crédito Fiscal', debe: monto*iva, haber: 0},
                    {cuenta: 'Caja', debe: 0, haber: total},
                ]
            });
            actualizarLibroMayor('Gastos operativos', monto);
            actualizarLibroMayor('IVA Crédito Fiscal', monto*iva);
            actualizarLibroMayor('Caja', -total);

            this.reset();
            mostrarGastos();
            mostrarLibroDiario();
            mostrarLibroMayor();
        };
        function mostrarGastos(){
            const tb = document.getElementById('tablaGastos');
            tb.innerHTML = '';
            gastos.slice().reverse().forEach((g, idx)=>{
                tb.innerHTML += `<tr>
                    <td>${g.fecha}</td>
                    <td>${g.categoria}</td>
                    <td>${g.proveedor}</td>
                    <td>${g.monto.toFixed(2)}</td>
                    <td>${(g.iva*100).toFixed(1)}%</td>
                    <td>${g.total.toFixed(2)}</td>
                    <td>${g.detalle||''}</td>
                    <td>
                        <button class="b-action" onclick="editarGasto(${gastos.length-1-idx})">Editar</button>
                        <button class="b-action" onclick="eliminarGasto(${gastos.length-1-idx})">Eliminar</button>
                    </td>
                </tr>`;
            });
        }
        window.editarGasto = function(idx){
            const g = gastos[idx];
            if(!g) return;
            document.getElementById('categoriaGasto').value = g.categoria;
            document.getElementById('proveedorGasto').value = g.proveedor;
            document.getElementById('montoGasto').value = g.monto;
            document.getElementById('ivaGasto').value = g.iva;
            document.getElementById('detalleGasto').value = g.detalle;
            eliminarGasto(idx);
        };
        window.eliminarGasto = function(idx){
            gastos.splice(idx,1);
            setLS('gastos', gastos);
            mostrarGastos();
        };

        // Selects dependientes
        function cargarSelects(){
            // Productos en compras
            const selProdCompra = document.getElementById('productoCompra');
            selProdCompra.innerHTML = '<option value="">Seleccione un Producto</option>';
            productos.forEach(p=>{
                selProdCompra.innerHTML += `<option value="${p.nombre}">${p.nombre}</option>`;
            });
            // Productos en ventas (solo con stock)
            const selProdVenta = document.getElementById('productoVenta');
            selProdVenta.innerHTML = '<option value="">Seleccione un Producto</option>';
            productos.forEach(p=>{
                if(p.stock>0) selProdVenta.innerHTML += `<option value="${p.nombre}">${p.nombre}</option>`;
            });
            // Proveedores en compras
            const selProv = document.getElementById('proveedorCompra');
            selProv.innerHTML = '<option value="">Seleccione un Proveedor</option>';
            proveedores.forEach(p=>{
                selProv.innerHTML += `<option value="${p.nombre}">${p.nombre}</option>`;
            });
            // Proveedores en gastos
            const selProvG = document.getElementById('proveedorGasto');
            selProvG.innerHTML = '<option value="">Seleccione un Proveedor</option>';
            proveedores.forEach(p=>{
                selProvG.innerHTML += `<option value="${p.nombre}">${p.nombre}</option>`;
            });
            // Clientes en ventas
            const selClienteVenta = document.getElementById('clienteVenta');
            selClienteVenta.innerHTML = '<option value="">Seleccione un Cliente</option>';
            clientes.forEach(c=>{
                selClienteVenta.innerHTML += `<option value="${c.nombre}">${c.nombre}</option>`;
            });
        }

        // Libros
        function registrarLibroDiario({fecha, descripcion, asientos}){
            asientos.forEach(a=>{
                libroDiario.push({
                    fecha, descripcion, cuenta: a.cuenta,
                    debe: a.debe, haber: a.haber
                });
            });
            setLS('libroDiario', libroDiario);
        }
        function mostrarLibroDiario(){
            const tb = document.getElementById('tablaLibroDiario');
            tb.innerHTML = '';
            libroDiario.slice().reverse().forEach(l=>{
                tb.innerHTML += `<tr>
                    <td>${l.fecha}</td>
                    <td>${l.descripcion}</td>
                    <td>${l.cuenta}</td>
                    <td>${l.debe ? l.debe.toFixed(2) : ''}</td>
                    <td>${l.haber ? l.haber.toFixed(2) : ''}</td>
                </tr>`;
            });
        }
        function actualizarLibroMayor(cuenta, monto){
            if(!libroMayor[cuenta]) libroMayor[cuenta]=0;
            libroMayor[cuenta] += monto;
            setLS('libroMayor', libroMayor);
        }
        function mostrarLibroMayor(){
            const tb = document.getElementById('tablaLibroMayor');
            tb.innerHTML = '';
            cuentas.forEach(c=>{
                let saldo = libroMayor[c] || 0;
                tb.innerHTML += `<tr>
                    <td>${c}</td>
                    <td>${saldo.toFixed(2)}</td>
                </tr>`;
            });
        }

        // Reportes
        function mostrarReporte() {
            let tipo = document.getElementById('tipoReporte').value;
            let fecha = document.getElementById('fechaReporte').value;
            if(!fecha) {
                document.getElementById('reporteResultado').innerHTML = `<b>Seleccione una fecha.</b>`;
                return;
            }
            let ventas_f = ventas.filter(v => {
                let f = (new Date(v.fecha)).toISOString().slice(0,10);
                if(tipo==='diario') return f===fecha;
                if(tipo==='mensual') return f.slice(0,7)===fecha.slice(0,7);
            });
            let compras_f = compras.filter(v => {
                let f = (new Date(v.fecha)).toISOString().slice(0,10);
                if(tipo==='diario') return f===fecha;
                if(tipo==='mensual') return f.slice(0,7)===fecha.slice(0,7);
            });
            let gastos_f = gastos.filter(v => {
                let f = (new Date(v.fecha)).toISOString().slice(0,10);
                if(tipo==='diario') return f===fecha;
                if(tipo==='mensual') return f.slice(0,7)===fecha.slice(0,7);
            });
            let totalVentas = ventas_f.reduce((a,v)=>a+v.total,0);
            let totalCompras = compras_f.reduce((a,v)=>a+v.total,0);
            let totalGastos = gastos_f.reduce((a,v)=>a+v.total,0);

            let html = `<b>Total Ventas:</b> $${totalVentas.toFixed(2)}<br>
            <b>Total Compras:</b> $${totalCompras.toFixed(2)}<br>
            <b>Total Gastos:</b> $${totalGastos.toFixed(2)}<br>
            <b>Balance:</b> $${(totalVentas-totalCompras-totalGastos).toFixed(2)}`;

            // Listas detalladas
            html += "<hr><b>Ventas:</b><br>";
            html += ventas_f.length ? "<ul>" + ventas_f.map(v=>`<li>${v.fecha}: ${v.producto} x${v.cantidad} $${v.total.toFixed(2)} (${v.tipoPago})</li>`).join('') + "</ul>" : "Sin ventas.<br>";
            html += "<b>Compras:</b><br>";
            html += compras_f.length ? "<ul>" + compras_f.map(c=>`<li>${c.fecha}: ${c.producto} x${c.cantidad} $${c.total.toFixed(2)} (${c.proveedor})</li>`).join('') + "</ul>" : "Sin compras.<br>";
            html += "<b>Gastos:</b><br>";
            html += gastos_f.length ? "<ul>" + gastos_f.map(g=>`<li>${g.fecha}: ${g.categoria} $${g.total.toFixed(2)} (${g.proveedor})</li>`).join('') + "</ul>" : "Sin gastos.<br>";

            document.getElementById('reporteResultado').innerHTML = html;
        }

        // Inicialización
        recargarTablas();
    </script>
</body>
</html>